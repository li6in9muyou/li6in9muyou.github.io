<!doctype html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="互斥锁的实现：软件方法 Implementation of software mutex locks" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="See it live at live demo" /><meta property="og:description" content="See it live at live demo" /><link rel="canonical" href="https://li6in9muyou.github.io/posts/software-mutex-simulation/" /><meta property="og:url" content="https://li6in9muyou.github.io/posts/software-mutex-simulation/" /><meta property="og:site_name" content="Li6q 笔记" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-15T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="互斥锁的实现：软件方法 Implementation of software mutex locks" /><meta name="twitter:site" content="@" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-03-19T00:05:47+08:00","datePublished":"2022-10-15T00:00:00+08:00","description":"See it live at live demo","headline":"互斥锁的实现：软件方法 Implementation of software mutex locks","mainEntityOfPage":{"@type":"WebPage","@id":"https://li6in9muyou.github.io/posts/software-mutex-simulation/"},"url":"https://li6in9muyou.github.io/posts/software-mutex-simulation/"}</script><title>互斥锁的实现：软件方法 Implementation of software mutex locks | Li6q 笔记</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Li6q 笔记"><meta name="application-name" content="Li6q 笔记"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://cdnjs.cloudflare.com" ><link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/li6in9muyou.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">Li6q 笔记</a></h1><p class="site-subtitle fst-italic mb-0">A blog of a unique person.</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>关于</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/li6in9muyou" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['libq5520','mails.jlu.edu.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">首页</a> </span> <span>互斥锁的实现：软件方法 Implementation of software mutex locks</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> 文章</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">取消</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>互斥锁的实现：软件方法 Implementation of software mutex locks</h1><div class="post-meta text-muted"> <span> 发表于 <time data-ts="1665763200" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2022/10/15 </time> </span> <span> 更新于 <time data-ts="1679155547" data-df="YYYY/MM/DD" data-bs-toggle="tooltip" data-bs-placement="bottom" > 2023/03/19 </time> </span><div class="d-flex justify-content-between"> <span> 作者 <em> <a href="https://github.com/li6in9muyou">Li 6in9Muyou</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1692 字" > <em>9 分钟</em>阅读</span></div></div></header><div class="content"><p>See it live at <a href="https://li6in9muyou.github.io/software-mutex-sim/">live demo</a></p><p>I built a simple app to demonstrate the execution of 4 algorithms that solved the mutex problem. The mutex problem is to ensure that only one of many concurrently running processes is executing the critical region. Being a software solution means that it requires no special hardware or special instructions e.g. test-and-set, compare-and-swap.</p><p>The four algorithms I was asked to implement are:</p><ul><li>Lamport’s bakery algorithm<li>Dekker’s<li>Peterson’s<li>Eisenberg &amp; McGuire’s</ul><h2 id="features"><span class="me-2">Features</span><a href="#features" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>Each (simulated) process can be paused and resumed during execution<li>Global memory is updated in real-time<li>Line number of source code at which the process is executing is updated in real-time</ul><h2 id="background"><span class="me-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This app simulates a scenario where many processes are contending a lock. These algorithms implements <code class="language-plaintext highlighter-rouge">lock()</code> and <code class="language-plaintext highlighter-rouge">unlock()</code> routines for such a lock. All four algorithms uses some shared memory, e.g. <code class="language-plaintext highlighter-rouge">wants_to_enter</code> and <code class="language-plaintext highlighter-rouge">turn</code> in the following snippet.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">async</span> <span class="kd">function</span> <span class="nf">lock</span><span class="p">(...)</span> <span class="p">{</span>
  <span class="nx">wants_to_enter</span><span class="p">[</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">TRUE</span><span class="p">;</span>
  <span class="k">while </span><span class="p">(</span><span class="nx">TRUE</span> <span class="o">===</span> <span class="nx">wants_to_enter</span><span class="p">[</span><span class="nf">counterpart</span><span class="p">(</span><span class="nx">pid</span><span class="p">)])</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">turn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">pid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>By definition, shared memory means that all processes are able to observe modifications made by other processes. Typically, <code class="language-plaintext highlighter-rouge">lock()</code> routine of these algorithms only writes to a same memory index, e.g. <code class="language-plaintext highlighter-rouge">pid</code>, and occasionally iterates over all elements in memory.</p><h2 id="implementation-considerations"><span class="me-2">Implementation Considerations</span><a href="#implementation-considerations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="concurrent-execution"><span class="me-2">concurrent execution</span><a href="#concurrent-execution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The JavaScript runtime is single-threaded thus to achieve concurrent execution in the browser is not straight forward. This problem is solved by spawning web workers which are mapped to real operating system threads.</p><h4 id="abandoned-approach-emulating-cpu"><span class="me-2">abandoned approach: emulating CPU</span><a href="#abandoned-approach-emulating-cpu" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Another approach would be to emulate CPU in one thread. This approach requires all four algorithms to be compiled into some sort of “assembly language” so that code can be broken up into pieces. By switching between “contexts”, parallel execution can be achieved.</p><p>For example, the following JavaScript code</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// original JavaScript code</span>
<span class="nx">wants_to_enter</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">who</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Dekker</span><span class="p">.</span><span class="nx">TRUE</span><span class="p">;</span>
<span class="k">while </span><span class="p">(</span><span class="nx">Dekker</span><span class="p">.</span><span class="nx">TRUE</span> <span class="o">===</span> <span class="nx">wants_to_enter</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nf">counterpart</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">who</span><span class="p">)])</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">turn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">who</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">wants_to_enter</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">who</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Dekker</span><span class="p">.</span><span class="nx">FALSE</span><span class="p">;</span>
    <span class="k">while </span><span class="p">(</span><span class="nx">turn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">who</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// busy waiting</span>
    <span class="p">}</span>
    <span class="nx">wants_to_enter</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">who</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Dekker</span><span class="p">.</span><span class="nx">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>can be compiled to</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="p">[</span>
  <span class="nc">Store</span><span class="p">(</span><span class="dl">"</span><span class="s2">wants_to_enter</span><span class="dl">"</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="nx">TRUE</span><span class="p">),</span>
  <span class="nc">JumpIfNotEqual</span><span class="p">(</span><span class="dl">"</span><span class="s2">wants_to_enter</span><span class="dl">"</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="nx">TRUE</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
  <span class="nc">JumpIfEqual</span><span class="p">(</span><span class="dl">"</span><span class="s2">turn</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
  <span class="nc">Store</span><span class="p">(</span><span class="dl">"</span><span class="s2">wants_to_enter</span><span class="dl">"</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="nx">FALSE</span><span class="p">),</span>
  <span class="nc">Noop</span><span class="p">(),</span>
  <span class="nc">JumpIfNotEqual</span><span class="p">(</span><span class="dl">"</span><span class="s2">turn</span><span class="dl">"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
  <span class="nc">Store</span><span class="p">(</span><span class="dl">"</span><span class="s2">wants_to_enter</span><span class="dl">"</span><span class="p">,</span> <span class="nx">pid</span><span class="p">,</span> <span class="nx">TRUE</span><span class="p">),</span>
<span class="p">];</span>
</pre></table></code></div></div><p>The above assembly is compiled manually. Dekker’s algorithm is the simplest one among them but compiling its code already requires a lot of tedious work. The approach is quickly abandoned.</p><h3 id="busy-waits"><span class="me-2">busy waits</span><a href="#busy-waits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Busy waits like</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">while </span><span class="p">(</span><span class="nf">should_wait</span><span class="p">(...))</span> <span class="p">{</span>
  <span class="c1">// busy wait</span>
<span class="p">}</span>
</pre></table></code></div></div><p>are exploited extensively in all four algorithms. Due to the nature of mutex problem, the condition that processes wait on is not going to change it’s that process’s turn to enter critical region. In another words, these busy waits waits a long time. A naïve implementation of busy wait consumes all computing resource of single CPU core which is bad. Things get worse when there are multiple processes contending the same critical region.</p><p>This problem is solved by awaiting a promise inside all busy wait loops. Waiting a promise effectively frees up the CPU so that the event loop will be able to pick up other tasks.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">while </span><span class="p">(</span><span class="nf">should_wait</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="observe-and-command-processes"><span class="me-2">observe and command processes</span><a href="#observe-and-command-processes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="tracing-hooks"><span class="me-2">tracing hooks</span><a href="#tracing-hooks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In order to report one process’s progress to UI sub-system, we can have them emit tracing events when executing. To do that, tracing function calls must be added in the algorithm implementation. The following example is the <code class="language-plaintext highlighter-rouge">lock()</code> routine of the Peterson’s algorithm. <code class="language-plaintext highlighter-rouge">break_point(...)</code> is tracing call which is named breakpoint because this call can pause function execution as well.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">async</span> <span class="kd">function</span> <span class="nf">lock</span><span class="p">(...)</span> <span class="p">{</span>
<span class="p">...</span>
  <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">victim</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="nx">level</span><span class="p">[</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
    <span class="nx">victim</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pid</span><span class="p">;</span>
    <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="k">await</span> <span class="nc">Yield</span><span class="p">();</span>
    <span class="p">...</span>
    <span class="p">}</span> <span class="k">while </span><span class="p">(</span><span class="o">!</span><span class="nf">can_proceed</span><span class="p">(</span><span class="nx">pid</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">victim</span><span class="p">));</span>

    <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
    <span class="k">await</span> <span class="nc">Yield</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In side <code class="language-plaintext highlighter-rouge">break_point</code> function call, it emits a <code class="language-plaintext highlighter-rouge">LineNumber</code> event.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">LineNumber</span> <span class="o">=</span> <span class="p">(</span><span class="nx">lineno</span><span class="p">:</span> <span class="nx">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">lineno</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">payload</span><span class="p">:</span> <span class="nx">lineno</span><span class="p">,</span>
<span class="p">});</span>
<span class="kd">const</span> <span class="nx">Pre</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">pre</span><span class="dl">"</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">Post</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">post</span><span class="dl">"</span> <span class="p">});</span>
<span class="kd">const</span> <span class="nx">Running</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">running</span><span class="dl">"</span> <span class="p">});</span>
</pre></table></code></div></div><p>Similarly, processes emit tracing events before and after critical region.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">async </span><span class="p">(...)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="p">...</span>
  <span class="nf">emit</span><span class="p">(</span><span class="nc">Running</span><span class="p">())</span>
  <span class="k">await</span> <span class="nf">lock_impl</span><span class="p">(...);</span>

  <span class="nf">emit</span><span class="p">(</span><span class="nc">Pre</span><span class="p">());</span>
  <span class="k">await</span> <span class="nf">critical_region</span><span class="p">();</span>
  <span class="nf">emit</span><span class="p">(</span><span class="nc">Post</span><span class="p">());</span>

  <span class="k">await</span> <span class="nf">unlock_impl</span><span class="p">(...);</span>
  <span class="nf">emit</span><span class="p">(</span><span class="nc">Completed</span><span class="p">());</span>
<span class="p">}</span>
</pre></table></code></div></div><h4 id="pause-a-process"><span class="me-2">pause a process</span><a href="#pause-a-process" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Pausing a process can be implemented as blocking at a function call or enter an idle loop. Utilizing the await semantics in JavaScript, I designed the following implementation to pause a running async function.</p><p>The execution of a <code class="language-plaintext highlighter-rouge">lock()</code> routine is paused when it awaits on a promise that is controlled by master thread. This promise is created when a pause request is received and is fulfilled when a resume request is received. <code class="language-plaintext highlighter-rouge">lock()</code> routine of Lamport’s algorithm is shown below.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">async</span> <span class="kd">function</span> <span class="nf">lock</span><span class="p">(...)</span> <span class="p">{</span>
<span class="p">...</span>
  <span class="nx">flag</span><span class="p">[</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">TRUE</span><span class="p">;</span>
  <span class="k">await</span> <span class="nf">break_point</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="nx">label</span><span class="p">[</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Statements for setting two elements is separated by an await statement where it’s going to waiting on the <code class="language-plaintext highlighter-rouge">_pause</code> promise inside call to <code class="language-plaintext highlighter-rouge">break_point()</code>. <code class="language-plaintext highlighter-rouge">request_resume()</code> and <code class="language-plaintext highlighter-rouge">request_resume()</code> is typically called from master thread.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">request_resume</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">shouldPause</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">_pause</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">_resolve</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">shouldPause</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">return</span> <span class="nf">resolve</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Pausing flag <code class="language-plaintext highlighter-rouge">shouldPause</code> along with <code class="language-plaintext highlighter-rouge">_pause</code> is set or cleared when a pause request is received. Naturally, <code class="language-plaintext highlighter-rouge">_resolve</code> is called when a resume request is received.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">request_resume</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">shouldPause</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nf">isUndefined</span><span class="p">(</span><span class="nx">_resolve</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">dbg</span><span class="p">(</span><span class="s2">`resume </span><span class="p">${</span><span class="nx">_i</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">_resolve</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nf">dbg</span><span class="p">(</span><span class="s2">`this process is not paused`</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="shared-global-memory"><span class="me-2">shared global memory</span><a href="#shared-global-memory" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Data exchange between master thread and worker threads is extremely limited. And worker threads can not directly access memory used by master thread.</p><h4 id="the-easy-way-shardarraybuffer"><span class="me-2">the easy way: ShardArrayBuffer</span><a href="#the-easy-way-shardarraybuffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>One solution to this problem is to use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer">SharedArrayBuffer</a>. When pass such objects to multiple workers, they can access the same underlying <code class="language-plaintext highlighter-rouge">ArrayBuffer</code> hence any updates to that <code class="language-plaintext highlighter-rouge">SharedArrayBuffer</code> is visible to all worker threads. However, to enable SharedArrayBuffer HTML document needs to be in a secure context. This “secure context” thing, in my scenario, boils down to setting two header entries at the server side. At first, I promptly set this up and call it a day. But later I realize that my page will be served on GitHub Pages where I can not set the response header entries. So I devised another approach.</p><h4 id="the-hairy-way-broadcast-writes"><span class="me-2">the hairy way: broadcast writes</span><a href="#the-hairy-way-broadcast-writes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Another approach would be manually syncing all memory writes. Every process sends its write requests to a centralized broadcaster. Upon receiving any write requests, the broadcaster broadcasts this request to all the other processes. When receiving write requests from other processes, process updates its local copy of global memory.</p><p>This approach eliminates the need for special headers and it can be employed in simple static web pages. I think this approach has a name in the field of distributed programming but I have not identified it yet.</p><pre><code class="language-mermaid">flowchart TB

A["Process#z, [0,89,0,0]"]---&gt;|set index 1 of some_array to be 89, please|Broadcaster
Broadcaster---&gt;|set index x of some_array to be y, please|Process#a["Process#a, [0,0,0,0]"]
Broadcaster---&gt;|...|Process#b["Process#b, [0,0,0,0]"]
Broadcaster---&gt;|...|Process#c["Process#c, [0,0,0,0]"]
</code></pre><p>Inevitably, local copies of individual processes will be stale from time to time but that’s ok because these 4 algorithms are all designed to work under such conditions. In fact, there is no ground truth for a global memory with this approach. Should there be any communication issues, i.e. packet lose, processes will never agree with each other any more. Furthermore, this approach is not easily scalable with numerous messages being passed around. Despite these shortcomings, it’s good enough for this particular application.</p><p>In practice, all processes subscribe to an observable in master thread and a broadcaster in master thread subscribe to all processes.</p><p>In master thread</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nx">process</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">((</span><span class="nx">args</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nf">isWriteRequest</span><span class="p">(</span><span class="nx">args</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processes</span><span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">process</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><p>And in simulated process’s code, we update local copy on every write</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">[</span><span class="nx">slice</span><span class="p">,</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">arr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ev</span><span class="p">;</span>
  <span class="nx">local_copy</span><span class="p">[</span><span class="nx">slice</span><span class="p">][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="general-design"><span class="me-2">General Design</span><a href="#general-design" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Operations on a simulated process can be categorized as a command e.g. pause or a query e.g. whether it’s in critical region. UI subsystem subscribes to event source provided by an adapter and updates UI accordingly. Users resume/pause processes through <code class="language-plaintext highlighter-rouge">IProcessComand</code>.</p><h3 id="iprocess-and-iprocessgroup"><span class="me-2">IProcess and IProcessGroup</span><a href="#iprocess-and-iprocessgroup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Simulated process is modeled by two interfaces as follows:</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">IProcessQuery</span> <span class="p">{</span>
  <span class="nl">pid</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="nl">execution_state</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ProcessLifeCycle</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">program</span><span class="p">:</span> <span class="nx">IProgram</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IProgram</span> <span class="p">{</span>
  <span class="nl">locking_state</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">LockingState</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="nl">line_number</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IProcessCommand</span> <span class="p">{</span>
  <span class="nf">start</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nf">resume</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nf">pause</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nf">kill</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="nf">set_breakpoint</span><span class="p">(</span><span class="nx">to_be</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">):</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Shared memory is attached to a group of contending processes. Furthermore, <code class="language-plaintext highlighter-rouge">IProcessGroup</code> is used to pause/resume all processes at the same time.</p><p>Finally, a process group is modeled as follows. Note that <code class="language-plaintext highlighter-rouge">IProcessGroup.pid</code> and <code class="language-plaintext highlighter-rouge">IProcessGroup.all</code> implements the <code class="language-plaintext highlighter-rouge">IProcessCommand</code> interface hence UI subsystem commands them transparently.</p><div class="language-typescript highlighter-rouge"><div class="code-header"> <span data-label-text="TypeScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="kr">interface</span> <span class="nx">IProcessGroupQuery</span> <span class="p">{</span>
  <span class="nl">execution_state</span><span class="p">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">ProcessLifeCycle</span><span class="o">&gt;</span><span class="p">[];</span>
  <span class="nl">program</span><span class="p">:</span> <span class="nx">IProgram</span><span class="p">[];</span>
  <span class="nl">memory</span><span class="p">:</span> <span class="nb">Map</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nb">Array</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">interface</span> <span class="nx">IProcessGroup</span> <span class="p">{</span>
  <span class="nl">all</span><span class="p">:</span> <span class="nx">IProcessGroupQuery</span> <span class="o">&amp;</span> <span class="nx">IProcessCommand</span><span class="p">;</span>

  <span class="nf">pid</span><span class="p">(</span><span class="nx">pid</span><span class="p">:</span> <span class="kr">number</span><span class="p">):</span> <span class="nx">IProcess</span><span class="p">;</span>

  <span class="nl">process_count</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Note that type <code class="language-plaintext highlighter-rouge">Observable</code> used above is nothing more than an interface with a simple <code class="language-plaintext highlighter-rouge">subscribe(subscriber)</code> method. It’s a rather generic and universal concept so I suppose it’s ok to put it in interfaces without limiting implementation at any way.</p><p>In <code class="language-plaintext highlighter-rouge">IProcessGroupQuery</code>, memory is modeled as a <code class="language-plaintext highlighter-rouge">Map&lt;string, ...&gt;</code> where its keys are names of shared objects used in algorithm implementations. UI sub-systems consumes this interface by subscribing to every item in this <code class="language-plaintext highlighter-rouge">Map</code> object and updates when events are emitted.</p><h2 id="implementation-details"><span class="me-2">Implementation Details</span><a href="#implementation-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="ui-subsystem"><span class="me-2">UI subsystem</span><a href="#ui-subsystem" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>UI is built with <a href="https://svelte.dev/">svelte</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/projectexperience/">ProjectExperience</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mutex/" class="post-tag no-text-decoration" >mutex</a> <a href="/tags/javascript/" class="post-tag no-text-decoration" >javascript</a> <a href="/tags/svelte/" class="post-tag no-text-decoration" >svelte</a> <a href="/tags/frontend/" class="post-tag no-text-decoration" >frontend</a> <a href="/tags/jlu-assignment/" class="post-tag no-text-decoration" >JLU-assignment</a> <a href="/tags/concurrent-programming/" class="post-tag no-text-decoration" >concurrent-programming</a> <a href="/tags/threads/" class="post-tag no-text-decoration" >threads</a> <a href="/tags/algorithm/" class="post-tag no-text-decoration" >algorithm</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">分享</span> <span class="share-icons"> <a href="http://service.weibo.com/share/share.php?title=%E4%BA%92%E6%96%A5%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%20Implementation%20of%20software%20mutex%20locks%20-%20Li6q%20%E7%AC%94%E8%AE%B0&url=https%3A%2F%2Fli6in9muyou.github.io%2Fposts%2Fsoftware-mutex-simulation%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <a href="https://twitter.com/intent/tweet?text=%E4%BA%92%E6%96%A5%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%20Implementation%20of%20software%20mutex%20locks%20-%20Li6q%20%E7%AC%94%E8%AE%B0&url=https%3A%2F%2Fli6in9muyou.github.io%2Fposts%2Fsoftware-mutex-simulation%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E4%BA%92%E6%96%A5%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%20Implementation%20of%20software%20mutex%20locks%20-%20Li6q%20%E7%AC%94%E8%AE%B0&u=https%3A%2F%2Fli6in9muyou.github.io%2Fposts%2Fsoftware-mutex-simulation%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fli6in9muyou.github.io%2Fposts%2Fsoftware-mutex-simulation%2F&text=%E4%BA%92%E6%96%A5%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%9A%E8%BD%AF%E4%BB%B6%E6%96%B9%E6%B3%95%20Implementation%20of%20software%20mutex%20locks%20-%20Li6q%20%E7%AC%94%E8%AE%B0" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="分享链接" data-title-succeed="链接已复制！" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">最近更新</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/pursuit-of-speed/">快点、再快点。the pursuit of speed</a><li class="text-truncate lh-lg"> <a href="/posts/interview-questions/">前端面试题目。crap</a><li class="text-truncate lh-lg"> <a href="/posts/concurrency-models/">大略了解并发模型。seven concurrency models in seven weeks</a><li class="text-truncate lh-lg"> <a href="/posts/howto-write-a-post/">如何给本站添加文章</a><li class="text-truncate lh-lg"> <a href="/posts/git-101/">git 基础。git 101</a></ul></section><section><h2 class="panel-heading">热门标签</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/frontend/">frontend</a> <a class="post-tag btn btn-outline-primary" href="/tags/teamwork/">teamwork</a> <a class="post-tag btn btn-outline-primary" href="/tags/algorithm/">algorithm</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c++</a> <a class="post-tag btn btn-outline-primary" href="/tags/chore/">chore</a> <a class="post-tag btn btn-outline-primary" href="/tags/database/">database</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/tooling/">tooling</a> <a class="post-tag btn btn-outline-primary" href="/tags/bash/">bash</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c#</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">文章内容</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">相关文章</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/thoughts-on-book-list-demo-app/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1652025600" data-df="YYYY/MM/DD" > 2022/05/09 </time><h4 class="pt-0 my-2">书单分享项目：反思和批判</h4><div class="text-muted"><p> 编者按：这是对一个书单分享应用 demo 的反思，项目地址。使用 svelte 开发，持续了一个月。 e-library 项目 routes.js定义了 URL 字面量到 svelte 组件映射以及页面名字到 URL 字面量的映射，前者是给路由库使用的路由定义，后者是在 HTML 中嵌入链接时使用的常量。每个页面都大致对应系统的一个子系统，调试页则聚合了相关的功能。最初分为如下几...</p></div></div></a></article><article class="col"> <a href="/posts/debug-101/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1629129600" data-df="YYYY/MM/DD" > 2021/08/17 </time><h4 class="pt-0 my-2">如何debug。</h4><div class="text-muted"><p> Author’s Note: It is one of the projects required by freeCodeCamp’s Developer Certification of [Front End Development Libraries] (https://www.freecodecamp.org/learn/front-end-development-librari...</p></div></div></a></article><article class="col"> <a href="/posts/book-list-app-design/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1649952000" data-df="YYYY/MM/DD" > 2022/04/15 </time><h4 class="pt-0 my-2">书单分享项目：设计分析</h4><div class="text-muted"><p> Author’s Note: basically nonsense. 小小的视觉组件承担了太多的业务逻辑，这不合理，搞得我的组件不能复用，改逻辑也要到很多个地方去改。 最著名的例子就是一个checkbox承担了新建书单的任务。这么一个不起眼的东西不应该包括这么多业务逻辑。 在BookLIstCheckBox.svelte中，这个组件显示为一个 checkbox，依附于某一本书，对...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/shenjimiaosuan-contest/" class="btn btn-outline-primary" aria-label="上一篇" ><p>神机妙算算法竞赛</p></a> <a href="/posts/quick-file-transfer/" class="btn btn-outline-primary" aria-label="下一篇" ><p>快速方便的文件传输工具。quick and straight-forward file transfer tool</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/li6in9muyou">Li 6in9Muyou</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。" >保留部分权利。</span></p><p>本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">热门标签</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/frontend/">frontend</a> <a class="post-tag btn btn-outline-primary" href="/tags/teamwork/">teamwork</a> <a class="post-tag btn btn-outline-primary" href="/tags/algorithm/">algorithm</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c++</a> <a class="post-tag btn btn-outline-primary" href="/tags/chore/">chore</a> <a class="post-tag btn btn-outline-primary" href="/tags/database/">database</a> <a class="post-tag btn btn-outline-primary" href="/tags/python/">python</a> <a class="post-tag btn btn-outline-primary" href="/tags/tooling/">tooling</a> <a class="post-tag btn btn-outline-primary" href="/tags/bash/">bash</a> <a class="post-tag btn btn-outline-primary" href="/tags/c/">c#</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/zh.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js,npm/mermaid@10.8.0/dist/mermaid.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src=""></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); mermaid.init(undefined, ".mermaid"); window.addEventListener("message", updateMermaid); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
